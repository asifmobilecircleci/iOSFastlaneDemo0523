platform :ios do
  desc "Update provisioning profiles"

  lane :update_provisioning_profiles do


      app_store_connect_api_key(
        key_id: "977Q72TV9V",
        issuer_id: "8f479d91-71d3-45b4-af9a-c075f1b748f0",
        key_content: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JR1RBZ0VBTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEJIa3dkd0lCQVFRZ20rcFJJM2NtUUdZVEVQNEEKWXk5ZlA1b0wxbDJndUxWK3p2VkxkbGRGYUlHZ0NnWUlLb1pJemowREFRZWhSQU5DQUFSNDJzRldWZFAvc3RULwpaNWkrenlMeWhZUEdhYlBKTTdPSnoveHZuZy9iZ2l0UmwyN1dsMGNHZWVlSzkwbitTVnpiemE0QzJKTXBJWnM1CngvOUdSUFNOCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0="
      )

      match(readonly: false)
   
  end

  desc "Build the app and test IPA, then upload to Sauce Labs"
  lane :build_and_upload do
    setup_ci

    update_provisioning_profiles 

    # Build the app IPA
    build_app(
      scheme: "DemoApp",
      export_method: "app-store",
      output_directory: "./output",
      output_name: "DemoApp.ipa"
    )

    # Build the test IPA for UI testing
    build_app(
      scheme: "DemoApp",
      configuration: "Debug",
      export_method: "development",
      output_directory: "./output",
      output_name: "DemoAppTest.ipa"
    )

    # Upload to Sauce Labs
    sh "curl -u $SAUCE_USERNAME:$SAUCE_ACCESS_KEY -X POST -H 'Content-Type: application/octet-stream' https://api.us-west-1.saucelabs.com/v1/storage/upload --data-binary @./output/DemoAppTest.ipa?overwrite=true"
  end

  desc "Run XCUI tests on Sauce Labs"
  lane :run_xcui_tests_on_sauce_lab do
    scan(
      scheme: "DemoAppUITests",
      devices: ["iPhone 12"],
      derived_data_path: "./output/derived_data",
      output_directory: "./output/test_output",
      result_bundle: true
    )
  end
end
